var __accessCheck=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)},__privateGet=(e,t,r)=>(__accessCheck(e,t,"read from private field"),r?r.call(e):t.get(e)),__privateAdd=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},__privateSet=(e,t,r,i)=>(__accessCheck(e,t,"write to private field"),i?i.call(e,r):t.set(e,r),r),__privateMethod=(e,t,r)=>(__accessCheck(e,t,"access private method"),r);!function(e){!function(e){var t,r,i,n,s,o,a,c,u,d,l,p,h,v,g,w,f,y,m,_,S,b,I,P,D,E,T,A,C,V,k,U,L,F,N,O,x,B,R,W,G,M,j,$,J,H,q,z,K,Y,X,Z,Q,ee,te,re,ie,ne;"use strict";var se=(e=>(e["Await"]="await",e["Filter"]="filter",e["React"]="react",e["BackendTransfer"]="backend_transfer",e))(se||{}),oe=(e=>(e["AwaitClick"]="await_click",e["AwaitScroll"]="await_scroll",e["AwaitExit"]="await_exit",e["AwaitInactivity"]="await_inactivity",e["FilterUrl"]="filter_url",e["FilterSubscriber"]="filter_subscriber",e["FilterDevice"]="filter_device",e["FilterLocation"]="filter_location",e["FilterTime"]="filter_time",e["FilterVisit"]="filter_visit",e["FilterUniqueSessionVisit"]="filter_unique_session_visit",e["FilterPopup"]="filter_popup",e["FilterECommerceActivity"]="filter_ecommerce_activity",e["ReactDelay"]="react_delay",e["ReactScroll"]="react_scroll",e["ReactRedirect"]="react_redirect",e["ReactPopup"]="react_popup",e["ReactSendToBackend"]="react_send_to_backend",e))(oe||{});class ae extends Error{}const ce="true",ue="false",de="exit";class le extends ReferenceError{constructor(e){super(`Node of selector ${e} not found`)}}if(false){if("undefined"!=typeof navigator&&"ReactNative"===navigator.product&&"undefined"==typeof crypto)throw new Error("React Native does not have a built-in secure random generator. If you don’t need unpredictable IDs use `nanoid/non-secure`. For secure IDs, import `react-native-get-random-values` before Nano ID.");if("undefined"!=typeof msCrypto&&"undefined"==typeof crypto)throw new Error("Import file with `if (!window.crypto) window.crypto = window.msCrypto` before importing Nano ID to fix IE 11 support");if("undefined"==typeof crypto)throw new Error("Your browser does not have secure random generator. If you don’t need unpredictable IDs, you can use nanoid/non-secure.")}function pe(e){const t=document.cookie.match(new RegExp(`(^| )${e}=([^;]+)`));if(t)return t[2]}function he(e){return new Proxy({},{get(t,r){if(!(r in t))if("object"==typeof e&&null!==e)t[r]=structuredClone(e);else t[r]=e;return t[r]}})}t=new WeakMap;const ve={1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",0:"7"},ge=class extends class{constructor(){__privateAdd(this,t,he([]))}on(e,r,i={}){if(__privateGet(this,t)[e].push({once:i.once,listener:r}),i.signal)i.signal.addEventListener("abort",(()=>{this.off(e,r)}),{once:true})}off(e,r){__privateGet(this,t)[e]=__privateGet(this,t)[e].filter((e=>e.listener!==r))}emit(e,...r){__privateGet(this,t)[e].forEach((({listener:t,once:i})=>{if(t(...r),i)this.off(e,t)}))}}{constructor(e){super(),__privateAdd(this,s),__privateAdd(this,a),__privateAdd(this,u),__privateAdd(this,l),__privateAdd(this,p),__privateAdd(this,h),__privateAdd(this,v),__privateAdd(this,w),__privateAdd(this,r,void 0),__privateAdd(this,i,void 0),__privateAdd(this,n,void 0),__privateSet(this,n,null),this.hasUpstreamTimePassed=false,__privateSet(this,n,e)}static create(e){return new ge(e)}initVisitorEntry(e){if(__privateSet(this,r,e),__privateGet(this,n))if(__privateMethod(this,s,o).call(this))this.emit("upstreamPassed"),this.hasUpstreamTimePassed=true;else __privateMethod(this,a,c).call(this)}};let we=ge;r=new WeakMap,i=new WeakMap,n=new WeakMap,s=new WeakSet,o=function(){const{specific_date:e,delay_seconds:t}=__privateGet(this,n)||{};let r,i;if(e)r=__privateMethod(this,v,g).call(this);if(t)i=__privateMethod(this,w,f).call(this);return r||i},a=new WeakSet,c=function(){const e=__privateMethod(this,u,d).call(this);if(!Number.isNaN(e))if(e>0)__privateSet(this,i,window.setTimeout((()=>{this.emit("upstreamPassed"),this.hasUpstreamTimePassed=true}),e));else this.emit("upstreamPassed"),this.hasUpstreamTimePassed=true},u=new WeakSet,d=function(){var e;if(null==(e=__privateGet(this,n))?void 0:e.delay_seconds){const e=__privateGet(this,r).getTime()+1e3*__privateGet(this,n).delay_seconds;return Date.now()-e}if(__privateGet(this,n).specific_date)return Date.parse(__privateGet(this,n).specific_date)-Date.now();else return NaN},l=new WeakSet,(e,t)=>{const r=new Date(t);return e.includes((r.getHours()+1).toString())},p=new WeakSet,(e,t)=>{const r=new Date(t);return e.includes(r.getDate().toString())},h=new WeakSet,(e,t)=>{const r=new Date(t);return e.includes(ve[r.getDay().toString()])},v=new WeakSet,g=function(){return __privateGet(this,r).getTime()>Date.parse(__privateGet(this,n).specific_date)},w=new WeakSet,f=function(){const e=Date.now()-__privateGet(this,r).getTime();return 1e3*__privateGet(this,n).delay_seconds>e};class fe{constructor({id:e,externalId:t,properties:r,isRecurrent:i,upstream:n}){this.id=e,this.externalId=t,this.isRecurrent=i,this.properties=r,this.upstream=n}get nodeTypeGroup(){var e,t;if(this.type===oe.ReactSendToBackend)return se.BackendTransfer;else return null==(t=null==(e=this.type.match(/^(?<nodeGroupType>[a-zA-Z]*)_.*/))?void 0:e.groups)?void 0:t.nodeGroupType}startUpstreamCalculation(){this.upstreamService=we.create(this.upstream),this.upstreamService.initVisitorEntry(new Date),this.upstreamAbortController=new AbortController}waitForUpstreamPassed(){return new Promise((e=>{if(this.upstream)if(this.upstreamService.hasUpstreamTimePassed)e(Symbol.for("upstreamPassed"));else this.upstreamService.on("upstreamPassed",(()=>{e(Symbol.for("upstreamPassed"))}),{once:true,signal:this.upstreamAbortController.signal})}))}cancelUpstreamToResolveWait(){this.upstreamAbortController.abort()}shouldProcessHandler(){return!this.upstreamService.hasUpstreamTimePassed}}class ye extends fe{constructor(){super(...arguments),this.leaveFalseTimeout=null}waitForDelayLeaveFalse(){return new Promise((e=>{const{leaveFalseDelay:t}=this.properties;if(t)this.leaveFalseTimeout=window.setTimeout(e,t)}))}cleanLeaveFalseTimeout(){if(this.leaveFalseTimeout)window.clearTimeout(this.leaveFalseTimeout),this.leaveFalseTimeout=null}}const me="_grDebugMode",_e=new class{isDebugEnabled(){return!!window.sessionStorage.getItem(me)}startDebug(){window.sessionStorage.setItem(me,"true")}},Se=new class{get isLoggingEnabled(){return _e.isDebugEnabled()}log(...e){this.displayLog("log",...e)}info(...e){this.displayLog("info",...e)}error(...e){this.displayLog("error",...e)}warn(...e){this.displayLog("warn",...e)}displayLog(e,...t){if(this.isLoggingEnabled)console[e](...t)}},be=100;var Ie=(e=>(e["UuidHasBeenSet"]="grUuidHasBeenSet",e["PopupsRendererCustomUrl"]="grPopupsRendererCustomUrl",e))(Ie||{});class Pe{constructor(){__privateAdd(this,y,new Proxy({},{get(e,t){if(t in e)return e[t];else return e[t]=[],e[t]}}))}addEvent(e,t){__privateGet(this,y)[e].push(t)}drainEvents(e){const t=__privateGet(this,y)[e];return __privateGet(this,y)[e]=[],t}hasDelayedEvents(e){return __privateGet(this,y)[e].length>0}}y=new WeakMap,m=new WeakMap,_=new WeakMap;const De=new class{constructor(){__privateAdd(this,m,{}),__privateAdd(this,_,new Pe)}publish(e,...t){var r;let i=false;if(null==(r=__privateGet(this,m)[e])?void 0:r.length)__privateGet(this,m)[e].forEach((r=>{if(i)Se.error(`More than one subscriber is listening on event ${e}`);else r(...t),i=true,Se.log(`Event ${e} published with arguments'`,...t)}));else __privateGet(this,_).addEvent(e,t)}subscribe(e,t){if(!__privateGet(this,m)[e])__privateGet(this,m)[e]=[];if(__privateGet(this,_).hasDelayedEvents(e))__privateGet(this,_).drainEvents(e).forEach((e=>t(...e)));__privateGet(this,m)[e].push(t)}unsubscribe(e,t){var r;const i=null==(r=__privateGet(this,m)[e])?void 0:r.indexOf(t);if(i>-1)__privateGet(this,m)[e].splice(i,1)}removeListeners(e){delete __privateGet(this,m)[e]}};var Ee=(e=>(e["DeviceType"]="debug_device_type",e["Location"]="debug_location",e["VisitUrlPath"]="debug_visit_url_path",e["BrowserStorageLastActivityDate"]="debug_browser_storage_last_activity_date",e["NewVisitor"]="debug_new_visitor",e["HasUserVisitPage"]="debug_has_user_visit_page",e["Events"]="debug_events",e))(Ee||{});function Te(){const e=e=>{const t=sessionStorage.getItem(e);if(t){if([Ee.DeviceType,Ee.VisitUrlPath,Ee.Location].includes(e))return t;if(e===Ee.BrowserStorageLastActivityDate){const e=new Date(t);return isNaN(e.getTime())?void 0:e}if([Ee.NewVisitor,Ee.HasUserVisitPage,Ee.Events].includes(e))try{return JSON.parse(t)}catch(r){Se.error(`Invalid debug data for: ${e}`)}}};return{enabled:true,data:{[Ee.DeviceType]:e(Ee.DeviceType),[Ee.BrowserStorageLastActivityDate]:e(Ee.BrowserStorageLastActivityDate),[Ee.Location]:e(Ee.Location),[Ee.NewVisitor]:e(Ee.NewVisitor),[Ee.VisitUrlPath]:e(Ee.VisitUrlPath),[Ee.HasUserVisitPage]:e(Ee.HasUserVisitPage),[Ee.Events]:e(Ee.Events)}}}function Ae(e,t,r){const i=ke.debugObject;ke.debugObject={...i,data:{...null==i?void 0:i.data,[e]:t}},sessionStorage.setItem(e,r||String(t))}function Ce(e){var t,r;return null==(r=null==(t=ke.debugObject)?void 0:t.data)?void 0:r[e]}function Ve(e,t){return ke.isDebug?t:e}const ke=new class{initialize(e){const{xsid:t,grid:r,clientLatestGrid:i,domain:n,aid:s,useNOStorage:o,useBetterSubscriberIdentification:a,isServedFromCustomDomain:c,scriptsDomain:u,scriptsVersion:d,tracking:l,isDebugMode:p}=e;if(p)_e.startDebug();window.__grIntegrationConfig=window.__grIntegrationConfig||{cData:{aid:s,grid:r,domain:n,useNOStorage:o,useBetterSubscriberIdentification:a,isServedFromCustomDomain:c,clientLatestGrid:i},visitor:{email:null,eComId:null,xsid:t},tracking:{isEnabled:l},webEvents:{isModuleInitialized:false,visitorApplicationEndpoint:null},webPush:{customSwPath:null,wpid:null,pushDomain:null,promptEndpoint:null},analyticsData:{scriptsDomain:u,scriptsVersion:d},eventBus:De,debug:p?Te():void 0,delayedScripts:{}}}isWebEventModuleInitialized(){return window.__grIntegrationConfig.webEvents.isModuleInitialized??false}setWebEventModuleInitialized(){if(false===window.__grIntegrationConfig.webEvents.isModuleInitialized)window.__grIntegrationConfig.webEvents.isModuleInitialized=true}canUseBackendForSubscriberIdentification(){return window.__grIntegrationConfig.cData.useBetterSubscriberIdentification}getUserAid(){return window.__grIntegrationConfig.cData.aid}getClientLatestGrid(){return window.__grIntegrationConfig.cData.clientLatestGrid}getUserAnalyticsDomain(){return window.__grIntegrationConfig.cData.domain}enablePopupDevMode(){window.__grIntegrationConfig.setCustomPopupRendererUrl=e=>{window.sessionStorage.setItem(Ie.PopupsRendererCustomUrl,e)}}getPopupRendererCustomUrl(){return window.sessionStorage.getItem(Ie.PopupsRendererCustomUrl)}setCustomSwPath(e){if("string"!=typeof e)throw new Error("Path type must be string");if(!e.match(/gr_sw_main.js$/))throw new Error("Invalid sw file name");window.__grIntegrationConfig.webPush.customSwPath=e}getCustomSwPath(){var e;return null==(e=window.__grIntegrationConfig)?void 0:e.webPush.customSwPath}isTrackingEnabled(){return window.__grIntegrationConfig.tracking.isEnabled}isTrackingScriptServedFromCustomDomain(){return window.__grIntegrationConfig.cData.isServedFromCustomDomain}set visitorEmail(e){window.__grIntegrationConfig.visitor.email=e}get visitorEmail(){return window.__grIntegrationConfig.visitor.email}get pushWpid(){return window.__grIntegrationConfig.webPush.wpid}set pushWpid(e){window.__grIntegrationConfig.webPush.wpid=e}set pushDomain(e){window.__grIntegrationConfig.webPush.pushDomain=e}get pushDomain(){return window.__grIntegrationConfig.webPush.pushDomain}set pushPromptEndpoint(e){window.__grIntegrationConfig.webPush.promptEndpoint=e}get pushPromptEndpoint(){return window.__grIntegrationConfig.webPush.promptEndpoint}get eventBus(){return window.__grIntegrationConfig.eventBus}get canUseBackendStorageForEvents(){return window.__grIntegrationConfig.cData.useNOStorage}get webConnectScriptCdnUrl(){return window.__grIntegrationConfig.analyticsData.scriptsDomain}get webConnectCurrentScriptsVersion(){return window.__grIntegrationConfig.analyticsData.scriptsVersion}get isDebug(){var e,t;return!!(null==(t=null==(e=window.__grIntegrationConfig)?void 0:e.debug)?void 0:t.enabled)}set debugObject(e){window.__grIntegrationConfig.debug=e}get debugObject(){var e;return null==(e=window.__grIntegrationConfig)?void 0:e.debug}get delayedScripts(){var e;return(null==(e=window.__grIntegrationConfig)?void 0:e.delayedScripts)||{}}set delayedScripts(e){window.__grIntegrationConfig.delayedScripts=e}set visitorApplicationEndpoint(e){window.__grIntegrationConfig.webEvents.visitorApplicationEndpoint=e}get visitorApplicationEndpoint(){return window.__grIntegrationConfig.webEvents.visitorApplicationEndpoint}};var Ue,Le;(Le=Ue||(Ue={}))["PageVisit"]="visit",Le["Popup"]="popup",Le["ViewItem"]="view_item",Le["ViewCategory"]="view_category",Le["WishlistItem"]="wishlist_item",Le["LikeItem"]="like_item",Le["UnlikeItem"]="unlike_item",void(Le["ShopifyAbandonedCart"]="shopify_webhook_abandoned_cart");class Fe extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype),this.name=this.constructor.name}}class Ne extends Fe{constructor(e){super(e)}}const Oe={cartToken:"string",urlToken:"string",visitorEmail:"string"},xe=["cartToken","urlToken"];var Be,Re,We,Ge,Me,je,$e,Je,He;(He=Be||(Be={}))["Inline"]="inline",void(He["Popup"]="popup"),(Je=Re||(Re={}))["Hq"]="Hq",void(Je["Us"]="Us"),void((We||(We={}))["UserAid"]="X-Aid"),($e=Ge||(Ge={}))["Active"]="active",void($e["Inactive"]="inactive"),(je=Me||(Me={}))["FilterWebUrl"]="filter_web_url",je["TransferToBackend"]="transfer_to_backend",je["FilterWebSubscribers"]="filter_web_subscribers",je["AwaitScroll"]="await_scroll",void(je["ShowPopup"]="react_popup");const qe=204;function ze(e,t){const r=e.isTextResponse??(null==t?void 0:t.isTextResponse);return fetch(e,{...t,headers:{...null==t?void 0:t.headers,...(null==t?void 0:t.omitAidHeader)?{}:{[We.UserAid]:ke.getUserAid()}}}).then((async e=>{if(e.ok){if(e.status===qe)return;return r?e.text():e.json()}const t=await e.text();return Promise.reject({statusCode:e.status,message:t})}))}var Ke=(e=>(e["visitorUuid"]="gaVisitorUuid",e["visitorValuable"]="gaIsValuable",e["VisitorResubscribed"]="gaVisitorResubscribed",e))(Ke||{});const Ye=new class{getVisitorData(){return ze(new URL(`visitors/${ke.getUserAid()}/${pe(Ke.visitorUuid)}`,ke.getUserAnalyticsDomain()).href)}},Xe=1e3*60*60*24,Ze=1e3;function Qe(e,t){const r=new Date(e+t*Xe),i=new Date(r.getFullYear(),r.getMonth(),r.getDate(),0,0,0);return Date.now()>=Date.parse(i.toString())}async function et(e,{maxAttempts:t=void 0,delay:r=Ze,multiplyDelay:i=true,maxDelay:n=Ze}={}){const s=async o=>{try{return await e()}catch(c){if(t&&o+1>t)throw c;const e=i?r*o:r;return 0,a=n&&e>n?n:e,new Promise((e=>{setTimeout((()=>e(s(o+1))),a)}))}var a};return s(1)}class tt extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype),this.name=this.constructor.name}}class rt extends tt{}var it,nt,st,ot,at,ct,ut,dt,lt,pt,ht,vt,gt,wt,ft,yt,mt,_t,St,bt,It,Pt,Dt,Et,Tt,At,Ct,Vt,kt,Ut,Lt,Ft,Nt,Ot;(Ot=it||(it={}))["ShowWhenCondition"]="showWhenCondition",Ot["VisitorsCondition"]="visitors",Ot["DeviceCondition"]="device",Ot["LocationCondition"]="location",Ot["ECommerceCondition"]="ecommerce",Ot["TriggerFrequency"]="frequency",Ot["PreventDisplay"]="preventDisplay",void(Ot["DateRange"]="dateRange"),(Nt=nt||(nt={}))["Mobile"]="mobile",Nt["Tablet"]="tablet",void(Nt["Desktop"]="desktop"),(Ft=st||(st={}))["All"]="all",Ft["New"]="new",void(Ft["Returning"]="returning"),void((ot||(ot={}))["All"]="all"),(Lt=at||(at={}))["ConditionsLogicSeparator"]="conditionsLogicSeparator",void(Lt["ECommerceConditions"]="ecommerceConditions"),(Ut=ct||(ct={}))["Amount"]="amount",void(Ut["Date"]="date"),(kt=ut||(ut={}))["And"]="and",void(kt["Or"]="or"),(Vt=dt||(dt={}))["Exactly"]="exactly",Vt["LessThan"]="lessThan",void(Vt["MoreThan"]="moreThan"),(Ct=lt||(lt={}))["LastDays"]="lastDays",void(Ct["DateRange"]="dateRange"),(At=pt||(pt={}))["AnyProduct"]="any",At["AnyCategory"]="any",void(At["AnyProductLiked"]="any"),(Tt=ht||(ht={}))["Category"]="category",void(Tt["Product"]="product"),void((vt||(vt={}))["Product"]="product"),(Et=gt||(gt={}))["ViewProductOrCategory"]="productOrCategoryView",void(Et["LikeProduct"]="likeItem"),(Dt=wt||(wt={}))["Percent"]="percent",void(Dt["Selector"]="selector"),(Pt=ft||(ft={}))["Instantly"]="instantly",Pt["Delay"]="delay",Pt["Exit"]="exit",Pt["Scroll"]="scroll",void(Pt["Inactivity"]="inactivity"),(It=yt||(yt={}))["AfterSubmit"]="submit",It["AfterClose"]="close",void(It["AfterTimes"]="timesAmount"),(bt=mt||(mt={}))["Always"]="always",bt["Session"]="session",void(bt["EveryDays"]="everyDays"),(St=_t||(_t={}))[St["InvalidCssSelector"]=1]="InvalidCssSelector",St[St["EmptyCssSelector"]=2]="EmptyCssSelector",St[St["CssSelectorTooLong"]=3]="CssSelectorTooLong",St[St["CssInvalidType"]=4]="CssInvalidType",St[St["InvalidTimeoutProperty"]=5]="InvalidTimeoutProperty",St[St["ShowWhenScrollPercentInvalidValueType"]=6]="ShowWhenScrollPercentInvalidValueType",St[St["ShowWhenScrollPercentValueOutOfBound"]=7]="ShowWhenScrollPercentValueOutOfBound",St[St["VisitorTriggerEmpty"]=8]="VisitorTriggerEmpty",St[St["VisitorTriggerInvalidProperty"]=9]="VisitorTriggerInvalidProperty",St[St["DevicesTriggerEmpty"]=10]="DevicesTriggerEmpty",St[St["DevicesTriggerInvalidValue"]=11]="DevicesTriggerInvalidValue",St[St["FrequencyEmptyTrigger"]=12]="FrequencyEmptyTrigger",St[St["FrequencyTriggerInvalidName"]=13]="FrequencyTriggerInvalidName",St[St["FrequencyTriggerNDaysInvalidPropertyValue"]=14]="FrequencyTriggerNDaysInvalidPropertyValue",St[St["FrequencyTriggerNDaysEmptyValue"]=15]="FrequencyTriggerNDaysEmptyValue",St[St["PreventDisplayTriggerInvalidName"]=16]="PreventDisplayTriggerInvalidName",St[St["PreventDisplayTriggerAfterTimesNoValue"]=17]="PreventDisplayTriggerAfterTimesNoValue",St[St["PreventDisplayTriggerAfterTimesInvalidValue"]=18]="PreventDisplayTriggerAfterTimesInvalidValue",St[St["DateRangeInvalidFromDate"]=19]="DateRangeInvalidFromDate",St[St["DateRangeInvalidToDate"]=20]="DateRangeInvalidToDate",St[St["DateRangeDateFromAfterDateTo"]=21]="DateRangeDateFromAfterDateTo",St[St["DateRangeToBeforeCurrentTime"]=22]="DateRangeToBeforeCurrentTime",St[St["LocationEmptyTrigger"]=23]="LocationEmptyTrigger",St[St["LocationInvalidType"]=24]="LocationInvalidType",St[St["LackOfLogicSeparator"]=25]="LackOfLogicSeparator",St[St["LackOfTriggerConditions"]=26]="LackOfTriggerConditions",St[St["InvalidTriggerConditions"]=27]="InvalidTriggerConditions",St[St["NoProductOrCategorySelected"]=28]="NoProductOrCategorySelected",St[St["ProductInvalidType"]=29]="ProductInvalidType",St[St["CategoryInvalidType"]=30]="CategoryInvalidType",St[St["AmountInvalidConditionName"]=31]="AmountInvalidConditionName",St[St["AmountInvalidConditionValueType"]=32]="AmountInvalidConditionValueType",St[St["DateInvalidConditionName"]=33]="DateInvalidConditionName",St[St["DateLastDaysInvalidConditionValue"]=34]="DateLastDaysInvalidConditionValue",St[St["DateDateRangeInvalidConditionValue"]=35]="DateDateRangeInvalidConditionValue",St[St["DateDateRangeFromInvalidValue"]=36]="DateDateRangeFromInvalidValue",St[St["DateDateRangeToInvalidValue"]=37]="DateDateRangeToInvalidValue",St[St["DateDateRangeDateFromAfterDateTo"]=38]="DateDateRangeDateFromAfterDateTo",St[St["PopupTriggerInvalidName"]=39]="PopupTriggerInvalidName",St[St["PopupTriggerLackOfValuesInLikeItemTrigger"]=40]="PopupTriggerLackOfValuesInLikeItemTrigger",void(St[St["PopupTriggerLikeItemInvalidValues"]=41]="PopupTriggerLikeItemInvalidValues");var xt=(e=>(e[e["Mobile"]=480]="Mobile",e[e["Tablet"]=768]="Tablet",e))(xt||{});const Bt=Symbol("DeviceService");class Rt{constructor(e){if(new.target===Rt&&e!==Bt)throw new Error(`Invalid ${new.target.name} constructor`)}detectDeviceTypeByScreenWidth(e){var t;const{availWidth:r,availHeight:i}=screen;let n=null==(t=screen.orientation)?void 0:t.type;if(!n)n=window.matchMedia("(orientation: landscape)").matches?"landscape":"portrait";const s=n.match(/landscape/)?i:r;if(xt.Mobile>=s)return nt.Mobile;else if(s>xt.Mobile&&xt.Tablet>=s)return nt.Tablet;return e?nt.Tablet:nt.Desktop}getDeviceType(){const{userAgentData:e}=window.navigator;if(e){const{mobile:t}=e;if(t)return this.detectDeviceTypeByScreenWidth(true);else return nt.Desktop}return this.detectDeviceTypeByScreenWidth()}}const Wt=new Rt(Bt),Gt=Symbol("DebugDeviceService");class Mt extends Rt{constructor(e){if(super(),new.target===Mt&&e!==Gt)throw new Error(`Invalid ${new.target.name} constructor`)}getDeviceType(){const e=Ce(Ee.DeviceType);if(!e)return super.getDeviceType();if(!Object.values(nt).includes(e))return Se.error("Incorrect debug device type. Check if device is correct. Instead of that we will use normal values"),super.getDeviceType();else return e}setDeviceType(e){Ae(Ee.DeviceType,e)}}const jt=new Mt(Gt),$t=Symbol("LocationService");class Jt{constructor(e){if(new.target===Jt&&e!==$t)throw new Error(`Invalid ${new.target.name} constructor`)}getVisitorCountryCode(){const{domain:e}=window.__grIntegrationConfig.cData;return fetch(`${e}web-user-data/country`).then((e=>e.text()))}}const Ht=new Jt($t),qt=Symbol("DebugLocationService");class zt extends Jt{constructor(e){if(super(),new.target===zt&&e!==qt)throw new Error(`Invalid ${new.target.name} constructor`)}getVisitorCountryCode(){const e=Ce(Ee.Location);if(!e)return super.getVisitorCountryCode();else return Promise.resolve(e)}setVisitorCountryCode(e){if("string"!=typeof e)return Se.error("Incorrect debug country code value"),null;Ae(Ee.Location,e)}}const Kt=new zt(qt),Yt=400;class Xt extends tt{constructor(){super("Invalid time properties")}}const Zt=new Map,Qt=(e,t)=>{if(!Array.isArray(e))switch(typeof e){case"string":e=[e];break;case"undefined":e=[];break;default:throw new TypeError(`Expected '${t}' to be a string or an array, but got a type of '${typeof e}'`)}return e.filter((e=>{if("string"!=typeof e){if(void 0===e)return false;throw new TypeError(`Expected '${t}' to be an array of strings, but found a type of '${typeof e}' in the array`)}return true}))};function er(e,t,r){return((e,t,r,i)=>{if(e=Qt(e,"inputs"),0===(t=Qt(t,"patterns")).length)return[];t=t.map((e=>((e,t)=>{t={caseSensitive:false,...t};const r=e+JSON.stringify(t);if(Zt.has(r))return Zt.get(r);const i="!"===e[0];if(i)e=e.slice(1);e=(e=>{if("string"!=typeof e)throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")})(e).replace(/\\\*/g,"[\\s\\S]*");const n=new RegExp(`^${e}$`,t.caseSensitive?"":"i");return n.negated=i,Zt.set(r,n),n})(e,r)));const{allPatterns:n}=r||{},s=[];for(const o of e){let e;const r=[...t].fill(false);for(const[i,n]of t.entries())if(n.test(o))if(r[i]=true,e=!n.negated,!e)break;if(!(false===e||void 0===e&&t.some((e=>!e.negated))||n&&r.some(((e,r)=>!e&&!t[r].negated))))if(s.push(o),i)break}return s})(e,t,r,true).length>0}class tr extends tt{constructor(){super("Failed to parse data from JSON string")}}var rr=(e=>(e["Show"]="show",e["Close"]="close",e["Submit"]="submit",e))(rr||{});const ir=new class{constructor(){this.timer=Date.now()}getCurrentVisitOnPageTime(){return Date.now()-this.timer}};class nr{constructor(e){this.eventType=e,this.aid=window.__grIntegrationConfig.cData.aid,this.grid=window.__grIntegrationConfig.cData.grid,this.time=ir.getCurrentVisitOnPageTime(),this.uuid=pe(Ke.visitorUuid),this.url=window.location.href,this.occurredOn=new Date}get externalUid(){const{xsid:e,email:t,eComId:r}=window.__grIntegrationConfig.visitor;return r||e||t}toJSON(){return{aid:this.aid,grid:this.aid,uuid:this.uuid,externalUid:this.externalUid,time:this.time,url:this.url,eventType:this.eventType,occurredOn:this.occurredOn.toUTCString()}}toString(){return JSON.stringify(this.toJSON())}}class sr extends nr{constructor(e,t){super(Ue.Popup),this.popupEvent=e,this.popupId=t}toJSON(){return{...super.toJSON(),popupId:this.popupId,popupEvent:this.popupEvent}}}class or extends nr{toJSON(){return{...super.toJSON(),data:this.data}}}class ar extends or{constructor(e){super(Ue.ViewItem),this.data=e}}class cr extends nr{constructor(e){super(Ue.ViewCategory),this.data=e}toJSON(){return{...super.toJSON(),data:this.data}}}class ur extends or{constructor(e){super(Ue.WishlistItem),this.data=e}}class dr extends or{constructor(e){super(Ue.LikeItem),this.data=e}}class lr extends nr{constructor(e){super(Ue.ShopifyAbandonedCart),this.data=e}toJSON(){return{...super.toJSON(),data:this.data}}}class pr extends or{constructor(e){super(Ue.UnlikeItem),this.data=e}}const hr=class{static getPageVisitEvent(){return new nr(Ue.PageVisit)}static getPopupSubmitEvent(e){return new sr(rr.Submit,e)}static getPopupShowEvent(e){return new sr(rr.Show,e)}static getPopupCloseEvent(e){return new sr(rr.Close,e)}static getViewItemEvent(e){var t;return new ar(__privateMethod(t=hr,S,b).call(t,e))}static getWishlistItemEvent(e){var t;return new ur(__privateMethod(t=hr,S,b).call(t,e))}static getLikeItemEvent(e){var t;return new dr(__privateMethod(t=hr,S,b).call(t,e))}static getUnlikeItemEvent(e){var t;return new pr(__privateMethod(t=hr,S,b).call(t,e))}static getViewCategoryEvent(e){const{name:t,id:r,shop:i}=e;return new cr({id:r,...t&&{name:t},...i&&{shop:i}})}static getShopifyIntegrationAbandonedCartEvent(e){try{return(e=>{if("object"!=typeof e||null===e)throw new Ne("Invalid data parameter type");else{const t=Object.entries(Oe),r=Object.keys(e);if(!xe.every((e=>r.includes(e))))throw new Ne("Lack of required parameters");if(!t.every((([t,r])=>!e[t]||typeof e[t]===r)))throw new Ne("Properties have invalid type")}return true})(e),new lr((t=e,r=Object.keys(Oe),Object.entries(t).reduce(((e,[t,i])=>{if(r.includes(t))e[t]=i;return e}),{})))}catch(i){return Se.error(i),null}var t,r}};let vr=hr;S=new WeakSet,b=e=>{const{product:t,categories:r,shop:i}=e,n=["id"],s=["id","sku","name","vendor","price","currency"],o=["id","name"],a={product:{}};if(!(null==t?void 0:t.id))return Se.error(`Missing required param (product_id: ${(null==t?void 0:t.id)??"undefined"}`),null;if(Object.keys(i??{}).forEach((e=>{if(n.includes(e)){if(!a.shop)a.shop={};a.shop[e]=i[e]}})),Object.keys(t).forEach((e=>{if(s.includes(e))a.product[e]=t[e]})),Array.isArray(r))a.categories=r.map((e=>{const t={};if(Object.keys(e).forEach((r=>{if(o.includes(r))t[r]=e[r]})),t.id)return t;else return null})).filter(Boolean);return a},__privateAdd(vr,S);class gr{static sendJSON(e,t){navigator.sendBeacon(e,new Blob([JSON.stringify({...JSON.parse(t),[We.UserAid]:ke.getUserAid()})],{type:"application/json"}))}}const wr=new class{constructor(){this.popupsCachedData={}}getUserLastActivityDate(){const e=ke.getUserAid();return ze(new URL(`activity/session/${e}/${pe(Ke.visitorUuid)}`,ke.getUserAnalyticsDomain()).href)}async addPopupEventToStorage(e){gr.sendJSON(new URL("activity/event",ke.getUserAnalyticsDomain()).href,JSON.stringify(e.toJSON()))}async getPopupActivityData(e){if(this.popupsCachedData)return this.popupsCachedData;const t=ke.getUserAid();return this.popupsCachedData=await ze(new URL(`activity/popups/${t}/${pe(Ke.visitorUuid)}/${e}`,ke.getUserAnalyticsDomain()).href),this.popupsCachedData}async saveEventsToStorage(e){gr.sendJSON(new URL("activity/event",ke.getUserAnalyticsDomain()).href,JSON.stringify({aid:window.__grIntegrationConfig.cData.aid,grid:window.__grIntegrationConfig.cData.grid,events:e.map((e=>e.toJSON()))}))}};var fr=(e=>(e["SetDomain"]="setDomain",e["SetListToken"]="setListToken",e["SetUserId"]="setUserId",e["SetEvent"]="setEvent",e["SetCookie"]="setCookie",e["SetAutoFunnelData"]="setAutoFunnelData",e["Push"]="push",e["SetCustomServiceWorkerPath"]="setCustomSwPath",e["ViewItem"]="viewItem",e["ViewCategory"]="viewCategory",e["LikeItem"]="likeItem",e["UnlikeItem"]="unlikeItem",e["WishListItem"]="wishlistItem",e["ShopifyAbandonedCart"]="shopifyAbandonedCart",e["SaveEvent"]="saveEvent",e["FlushEvents"]="flushEvents",e["SetUserDevice"]="setUserDevice",e["SetUserLocation"]="setUserLocation",e["SetVisitUrlPath"]="setVisitUrlPath",e["SetLastActivityDate"]="setLastActivityDate",e["SetIsNewVisitor"]="setIsNewVisitor",e["SetHasUserVisitPage"]="setHasUserVisitPage",e["SetRawEvent"]="setRawEvent",e["ImportScript"]="importScript",e["DelayScript"]="delayScript",e["InitScript"]="initScript",e))(fr||{});const yr=Symbol("StorageService");class mr{constructor(e){if(new.target===mr&&e!==yr)throw new Error(`Invalid ${new.target.name} constructor`)}async isNewVisitor(){return!(await this.getLastActivityDate())}getLastActivityDate(){return ke.canUseBackendStorageForEvents?this.getLastActivityDateFromBackendStorage():this.getLastActivityDateFromBrowserStorage()}async getLastActivityDateFromBackendStorage(){const e=await wr.getUserLastActivityDate();if(null==e?void 0:e.lastActivity)return new Date(e.lastActivity)}getLastActivityDateFromBrowserStorage(){var e;const t=pe(Ke.visitorUuid),r=localStorage.getItem("gaLocalStorageVisitKey");let i;try{i=JSON.parse(r)}catch{throw new tr}if(null==i?void 0:i[t])return Promise.resolve(new Date(null==(e=i[t])?void 0:e.lastActivity));else return null}saveUserActivity(){ke.eventBus.publish(fr.SaveEvent,Ue.PageVisit,null,{sendToBackend:true,saveToLocal:false}),this.saveUserActivityToBrowserStorage()}saveUserActivityToBrowserStorage(){const e={[pe(Ke.visitorUuid)]:{lastActivity:vr.getPageVisitEvent().occurredOn.toUTCString()}};try{window.localStorage.setItem("gaLocalStorageVisitKey",JSON.stringify(e))}catch{throw new tr}}}const _r=new mr(yr),Sr=Symbol("DebugStorageService");class br extends mr{constructor(e){if(super(),new.target===br&&e!==Sr)throw new Error(`Invalid ${new.target.name} constructor`)}getLastActivityDate(){var e;const t=Ce(Ee.BrowserStorageLastActivityDate);if(isNaN(null==(e=null==t?void 0:t.getTime)?void 0:e.call(t)))return super.getLastActivityDate();else return Promise.resolve(t)}setLastActivityDate(e){const t=new Date(e);if(isNaN(t.getTime()))return Se.error("Incorrect dateString for last activity date. Try again with isoString."),null;Ae(Ee.BrowserStorageLastActivityDate,t,t.toISOString())}isNewVisitor(){const e=Ce(Ee.NewVisitor);if(void 0===e)return super.isNewVisitor();else return Promise.resolve(e)}setIsNewVisitor(e){Ae(Ee.NewVisitor,e,String(e))}}const Ir=new br(Sr);function Pr(){return Ve(_r,Ir)}var Dr=(e=>(e["Always"]="always",e["OnceEveryDays"]="xDays",e["Session"]="everySession",e))(Dr||{});const Er=Symbol("SessionService");class Tr{constructor(e){if(new.target===Tr&&e!==Er)throw new Error(`Invalid ${new.target.name} constructor`)}hasUserVisitedPage(){return this.getSessionVisitData().count>1}saveUserVisit(){const e=this.getSessionVisitData()||{count:0};sessionStorage.setItem("gaUserPageSessionVisit",JSON.stringify({...e,count:e.count+1}))}getSessionVisitData(){return JSON.parse(sessionStorage.getItem("gaUserPageSessionVisit"))}}const Ar=new Tr(Er),Cr=Symbol("DebugSessionService");class Vr extends Tr{constructor(e){if(super(),new.target===Vr&&e!==Cr)throw new Error(`Invalid ${new.target.name} constructor`)}hasUserVisitedPage(){const e=Ce(Ee.HasUserVisitPage);if(void 0===e)return super.hasUserVisitedPage();else return e}setHasUserVisitedPage(e){Ae(Ee.HasUserVisitPage,e)}}const kr=new Vr(Cr);function Ur(){return Ve(Ar,kr)}const Lr=Symbol("VisitService");class Fr{constructor(e){if(new.target===Fr&&e!==Lr)throw new Error(`Invalid ${new.target.name} constructor`)}async validateFrequencyProperty(e,t=0){if(e===Dr.Session)return!Ur().hasUserVisitedPage();else if(e===Dr.OnceEveryDays){const e=await Pr().getLastActivityDate();if(e)return Qe(e.getTime(),t)}return true}async validateVisitorsProperty(e){const t=await Pr().isNewVisitor();switch(e){case st.New:return t;case st.Returning:return!t;default:return true}}validateUrlPath(e="*"){const t=window.location.pathname;return this.validatePath(e,t)}validatePath(e,t){return er(t,e)}}const Nr=new Fr(Lr),Or=Symbol("DebugVisitService");class xr extends Fr{constructor(e){if(super(),new.target===xr&&e!==Or)throw new Error(`Invalid ${new.target.name} constructor`)}validateUrlPath(e="*"){const t=Ce(Ee.VisitUrlPath);if(void 0===t)return super.validateUrlPath(e);else return super.validatePath(e,t)}setVisitPathUrl(e){if("string"!=typeof e)return Se.error("Invalid url path type. Try again with string variable"),null;Ae(Ee.VisitUrlPath,e)}}const Br=new xr(Or);var Rr=(e=>(e["Events"]="gr_webconnect",e["VisitorJourneys"]="gr_visitor_journeys",e))(Rr||{});const Wr={gr_webconnect:1,gr_visitor_journeys:1};var Gr=(e=>(e["UserActivityEvents"]="user_activity_events",e))(Gr||{}),Mr=(e=>(e["EventType"]="eventType",e["VisitorUuid"]="visitorUuid",e["EventTypeWithVisitor"]="eventType, visitorUuid",e))(Mr||{}),jr=(e=>(e["VisitorJourneys"]="visitorJourneys",e["VisitorJourneysGraphHistory"]="visitorJourneysGraphHistory",e))(jr||{}),$r=(e=>(e["VisitorUuid"]="visitor_uuid",e["JourneyIdentifier"]="uuid",e["VisitorUuidWithJourneyIdentifier"]="visitor_uuid, uuid",e))($r||{}),Jr=(e=>(e["VisitorUuid"]="visitor.uuid",e["NodeUuid"]="node.uuid",e["VisitorUuidWithNodeUuid"]="visitor.uuid, node.uuid",e))(Jr||{});let Hr,qr;const zr=new WeakMap,Kr=new WeakMap,Yr=new WeakMap,Xr=new WeakMap,Zr=new WeakMap;let Qr={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return Kr.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Yr.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return ti(e[t])},set:(e,t,r)=>(e[t]=r,true),has(e,t){if(e instanceof IDBTransaction&&("done"===t||"store"===t))return true;else return t in e}};function ei(e){if("function"==typeof e)return function(e){if(e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype))return function(t,...r){const i=e.call(ri(this),t,...r);return Yr.set(i,t.sort?t.sort():[t]),ti(i)};if((qr||(qr=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e))return function(...t){return e.apply(ri(this),t),ti(zr.get(this))};else return function(...t){return ti(e.apply(ri(this),t))}}(e);if(e instanceof IDBTransaction)!(e=>{if(Kr.has(e))return;const t=new Promise(((t,r)=>{const i=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",s),e.removeEventListener("abort",s)},n=()=>{t(),i()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",n),e.addEventListener("error",s),e.addEventListener("abort",s)}));Kr.set(e,t)})(e);if(t=e,(Hr||(Hr=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e)))return new Proxy(e,Qr);else return e;var t}function ti(e){if(e instanceof IDBRequest)return(e=>{const t=new Promise(((t,r)=>{const i=()=>{e.removeEventListener("success",n),e.removeEventListener("error",s)},n=()=>{t(ti(e.result)),i()},s=()=>{r(e.error),i()};e.addEventListener("success",n),e.addEventListener("error",s)}));return t.then((t=>{if(t instanceof IDBCursor)zr.set(t,e)})).catch((()=>{})),Zr.set(t,e),t})(e);if(Xr.has(e))return Xr.get(e);const t=ei(e);if(t!==e)Xr.set(e,t),Zr.set(t,e);return t}const ri=e=>Zr.get(e),ii=["get","getKey","getAll","getAllKeys","count"],ni=["put","add","delete","clear"],si=new Map;function oi(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(si.get(t))return si.get(t);const r=t.replace(/FromIndex$/,""),i=t!==r,n=ni.includes(r);if(!(r in(i?IDBIndex:IDBObjectStore).prototype)||!(n||ii.includes(r)))return;const s=async function(e,...t){const s=this.transaction(e,n?"readwrite":"readonly");let o=s.store;if(i)o=o.index(t.shift());return(await Promise.all([o[r](...t),n&&s.done]))[0]};return si.set(t,s),s}var ai;ai=Qr,void(Qr={...ai,get(e,t,r){return oi(e,t)||ai.get(e,t,r)},has(e,t){return!!oi(e,t)||ai.has(e,t)}});const ci=new class{openEventsDatabaseConnection(e){return this.openConnection(Rr.Events,Wr[Rr.Events],e)}openAutomationJourneysDatabaseConnection(e){return this.openConnection(Rr.VisitorJourneys,Wr[Rr.VisitorJourneys],e)}async openConnection(e,t,r){const i=await((e,t,{blocked:r,upgrade:i,blocking:n,terminated:s}={})=>{const o=indexedDB.open(e,t),a=ti(o);if(i)o.addEventListener("upgradeneeded",(e=>{i(ti(o.result),e.oldVersion,e.newVersion,ti(o.transaction),e)}));if(r)o.addEventListener("blocked",(e=>r(e.oldVersion,e.newVersion,e)));return a.then((e=>{if(s)e.addEventListener("close",(()=>s()));if(n)e.addEventListener("versionchange",(e=>n(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a})(e,t,{blocked(e,t,r){Se.error(`Connection to old db version: ${t} not closed. Version ${e} not available`,r)},upgrade(e,t,i){Se.log(`New db version ${i} detected, upgrading from ${t}`),r(t,i,e)},terminated(){Se.log("Closing db connection")},blocking(e,t,r){Se.log(`Current connection od db version ${e} is blocking connection to version ${t}.`,r),i.close()}});return i}},ui=Symbol("BrowserEventsStorageService"),di=class{constructor(e){if(__privateAdd(this,I),new.target===di&&e!==ui)throw new Error(`Invalid ${new.target.name} constructor`)}async saveEvent(e){const t=e instanceof nr?e.toJSON():e;try{const e=(await ci.openEventsDatabaseConnection(__privateMethod(this,I,P))).transaction(Gr.UserActivityEvents,"readwrite"),r=e.objectStore(Gr.UserActivityEvents);await r.add(t),await e.done}catch(r){Se.error("Error while saving event to database",r)}}async getEvents(e){const t=pe(Ke.visitorUuid);try{const r=(await ci.openEventsDatabaseConnection(__privateMethod(this,I,P))).transaction(Gr.UserActivityEvents,"readwrite"),i=r.objectStore(Gr.UserActivityEvents).index(Mr.EventTypeWithVisitor),n=await i.getAll([e,t]);return await r.done,n}catch(r){Se.error("Error while reading from database",r)}}async getPopupECommerceEvents(e){const t=pe(Ke.visitorUuid),r=(await ci.openEventsDatabaseConnection(__privateMethod(this,I,P))).transaction(Gr.UserActivityEvents,"readwrite").store.index(Mr.VisitorUuid),i=[];let n=await r.openCursor(IDBKeyRange.only(t));for(;n;){const{value:t}=n;if(e(t))i.push(t);n=await n.continue()}return i}};let li=di;I=new WeakSet,P=(e,t,r)=>{if(0===e&&1===t)!(e=>{if(!e.objectStoreNames.contains(Gr.UserActivityEvents))try{const t=e.createObjectStore(Gr.UserActivityEvents,{keyPath:"id",autoIncrement:true});t.createIndex(Mr.EventType,"eventType",{unique:false}),t.createIndex(Mr.VisitorUuid,"uuid",{unique:false}),t.createIndex(Mr.EventTypeWithVisitor,["eventType","uuid"])}catch(t){Se.error("Error while initializing/upgrading database",t)}})(r)};const pi=new li(ui),hi=Symbol("DebugBrowserEventsStorageService");class vi extends li{constructor(e){if(super(),new.target===vi&&e!==hi)throw new Error(`Invalid ${new.target.name} constructor`)}async getPopupECommerceEvents(e){const t=Ce(Ee.Events)||[];if(!t.length)return super.getPopupECommerceEvents(e);else return t.filter(e)}async getEvents(e){const t=pe(Ke.visitorUuid),r=Ce(Ee.Events)||[];if(!r.length)return super.getEvents(e);else return r.filter((({eventType:r,uuid:i})=>r===e&&i===t))}async saveEvent(e){const t=e instanceof nr?e.toJSON():e,r=[...Ce(Ee.Events)||[],t];try{const e=JSON.stringify(r);Ae(Ee.Events,r,e)}catch(i){Se.error(`Can't parse new debug events. Try again.`)}}}const gi=new vi(hi);function wi(){return Ve(pi,gi)}function fi(e,t,r){return r.filter((r=>r.popupEvent===t&&r.popupId===e))}function yi(e,t){return fi(e,rr.Show,t).length>0}function mi(e,t){var r;const i=fi(e,rr.Show,t).sort(((e,t)=>Date.parse(t.occurredOn)-Date.parse(e.occurredOn)));if(!(null==(r=i[0])?void 0:r.occurredOn))return null;else return new Date(i[0].occurredOn)}function _i(e,t){return fi(e,rr.Close,t).length>0}function Si(e,t){return fi(e,rr.Submit,t).length>0}function bi(e,t){return fi(e,rr.Show,t).length}const Ii=new class{getStorage(){try{const e=localStorage.getItem("grPopupsServiceKey");return JSON.parse(e)}catch(e){Se.error("Failed to get local storage data",e)}}getPopupEvents(){return wi().getEvents(Ue.Popup)}async getLastPopupImpression(e){return mi(e,await this.getPopupEvents())}async getPopupImpressionsAmount(e){return bi(e,await this.getPopupEvents())}async hasPopupBeenClosedBefore(e){return _i(e,await this.getPopupEvents())}async hasPopupBeenSeenInSession(e){return yi(e,await this.getPopupEvents())}async hasPopupBeenSubmittedBefore(e){return Si(e,await this.getPopupEvents())}_getPopupEventsFromLocalStorage(){var e,t;return null==(t=null==(e=this.getStorage())?void 0:e.events)?void 0:t.filter((e=>e.popupEvent===rr.Submit||rr.Close||rr.Show))}registerPopupClose(e){return this.addEventToStorage(vr.getPopupCloseEvent(e))}registerPopupSubmit(e){return this.addEventToStorage(vr.getPopupSubmitEvent(e))}registerPopupView(e){return this.addEventToStorage(vr.getPopupShowEvent(e))}async migrateData(){if(!localStorage.getItem("grPopupsMigration")){const e=this._getPopupEventsFromLocalStorage();if(e)await Promise.all(e.map(this.addEventToStorage)),localStorage.setItem("grPopupsServiceKey",JSON.stringify({})),localStorage.setItem("grPopupsMigration","true")}}addEventToStorage(e){return wi().saveEvent(e)}},Pi=Symbol("PopupsService");class Di{constructor(e){if(new.target===Di&&e!==Pi)throw new Error(`Invalid ${new.target.name} constructor`)}setGrid(e){this.grid=e}setAid(e){this.aid=e}async registerPopupClose(e){return this.addEventToStorage(vr.getPopupCloseEvent(e))}async registerPopupSubmit(e){return this.addEventToStorage(vr.getPopupSubmitEvent(e))}async registerPopupView(e){return this.addEventToStorage(vr.getPopupShowEvent(e))}hasPopupBeenSeenInSession(e){return this.getPopupActivityData(e).then((e=>!!e.lastImpressionOccurredAt))}addEventToStorage(e){return wr.addPopupEventToStorage(e)}async getPopupActivityData(e){return wr.getPopupActivityData(e)}getLastPopupImpression(e){return this.getPopupActivityData(e).then((e=>new Date(e.lastImpressionOccurredAt)))}hasPopupBeenClosedBefore(e){return this.getPopupActivityData(e).then((e=>e.closes>0))}hasPopupBeenSubmittedBefore(e){return this.getPopupActivityData(e).then((e=>e.submits>0))}getPopupImpressionsAmount(e){return this.getPopupActivityData(e).then((e=>e.impressions))}}const Ei=new Di(Pi);function Ti(){return ke.canUseBackendStorageForEvents?Ei:Ii}const Ai=Symbol("DebugPopupService");class Ci extends Di{constructor(e){if(super(),this.hasPopupBeenSeenInSession=e=>{const t=this.getAllEvents();return Promise.resolve(yi(e,t))},this.getLastPopupImpression=e=>{var t;const r=mi(e,this.getAllEvents());if(isNaN(null==(t=null==r?void 0:r.getTime)?void 0:t.call(r)))return Ti().getLastPopupImpression(e);else return Promise.resolve(r)},this.hasPopupBeenClosedBefore=e=>{const t=this.getAllEvents();return Promise.resolve(_i(e,t))},this.hasPopupBeenSubmittedBefore=e=>{const t=this.getAllEvents();return Promise.resolve(Si(e,t))},this.getPopupImpressionsAmount=e=>{const t=this.getAllEvents();return Promise.resolve(bi(e,t))},new.target===Ci&&e!==Ai)throw new Error(`Invalid ${new.target.name} constructor`)}getAllEvents(){return Ce(Ee.Events)||[]}}const Vi=new Ci(Ai);function ki(){return Ve(Ti(),Vi)}const Ui="https://us-wbe.gr-cdn.com/dynamic/gr-popups.js",Li="https://",Fi="http://",Ni="www.";function Oi(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}class xi{constructor(e){this.url=e,this.enhancedUrls=[]}static create(e){return new xi(e)}withSlash(){if(!(this.url.endsWith("*")||this.url.endsWith("+")||this.url.includes("?")||this.url.endsWith("/")))this.url=`${this.url}/`;return this}withLackOfProtocolAndWww(){if(!this.url.startsWith("*")&&!this.hasProtocolIncluded()&&!this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${Li}${this.url}`,`${Fi}${this.url}`,`${Li}${Ni}${this.url}`,`${Fi}${Ni}${this.url}`];return this}withLackOfWww(){if(this.url.startsWith("*"))return this;if(this.hasProtocolIncluded()&&!this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${Li}${Ni}${this.url.replace(/^(http:\/\/|https:\/\/)/,"")}`,`${Fi}${Ni}${this.url.replace(/^(http:\/\/|https:\/\/)/,"")}`];return this}withLackOfProtocol(){if(this.url.startsWith("*"))return this;if(!this.hasProtocolIncluded()&&this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${Li}${this.url}`,`${Fi}${this.url}`];return this}enhance(){return[...this.enhancedUrls,this.url]}hasProtocolIncluded(){return this.url.startsWith(Li)||this.url.startsWith(Fi)}hasWwwPart(){return this.url.replace(/^(http:\/\/|https:\/\/)/,"").startsWith(Ni)}}function Bi(e,t){return"object"==typeof e&&null!==e&&"eventType"in e&&e["eventType"]===t}function Ri(e){return e.sort(((e,t)=>Date.parse(t.occurredOn)-Date.parse(e.occurredOn)))[0].eventType===Ue.LikeItem}const Wi=1e3*60*60*24;D=new WeakMap,E=new WeakMap,T=new WeakSet,A=(e,t,{ignoreToDateInDateRange:r}={})=>{const{occurredOn:i}=e;if(t){const{name:e,value:n}=t;if(e===lt.LastDays)return new Date(i).getTime()>Date.now()-n*Wi;if(e===lt.DateRange){const{from:e,to:t}=n,s=new Date(i).getTime(),o=!e||new Date(e).getTime()<s;let a=!t||s<new Date(t).getTime();if(r)a=true;return o&&a}return Se.error(`Unknown date condition name: ${e} in ecommerce activity filter node`),false}return true},C=new WeakSet,V=(e,t)=>{if(t){const{name:r,value:i}=t;switch(r){case dt.Exactly:return i===e.length;case dt.MoreThan:return e.length>i;case dt.LessThan:return i>e.length;default:!(e=>{Se.error(`Unsupported value: ${e}`)})(r)}}return e.length>0};const Gi=new class{constructor(){this.visitorFlow=[]}addEntry(e){this.visitorFlow.push(e)}hasElementBeenVisited(e){return!!this.visitorFlow.find((t=>t===e))}},Mi=Object.freeze({[ce]:true,[ue]:true}),ji=Object.freeze({[ce]:true}),$i=Object.freeze({[de]:true}),Ji=Object.freeze({}),Hi={[oe.AwaitClick]:class extends ye{constructor(){super(...arguments),this.type=oe.AwaitClick,this.outs=zi.getNodeOutsInstance(oe.AwaitClick)}async handler(){const{selector:e}=this.properties;try{return await this.waitForElementClick(e),ce}catch(t){if(t instanceof ae)return ue;Se.error(t)}}waitForElementClick(e){return new Promise(((t,r)=>{const i=document.querySelector(e),n=()=>{t(),this.cleanLeaveFalseTimeout()};if(i)i.addEventListener("click",n,{once:true}),this.waitForDelayLeaveFalse().then((()=>{i.removeEventListener("click",n),r(new ae)}));else r(new le(e))}))}},[oe.AwaitScroll]:class extends ye{constructor(){super(...arguments),this.type=oe.AwaitScroll,this.outs=zi.getNodeOutsInstance(oe.AwaitScroll)}async handler(){const{selector:e,percent:t}=this.properties;try{if(e)await this.watchForElementIntersectWithViewport(e);else if(t)await this.watchForPagePercentValueIntersectsWithViewport(t);return ce}catch(r){if(r instanceof ae)return ue;Se.error(r)}finally{this.cleanLeaveFalseTimeout()}}watchForElementIntersectWithViewport(e){return new Promise(((t,r)=>{const i=document.querySelector(e);if(i){const e=new IntersectionObserver(((e,r)=>{for(const n of e)if(n.isIntersecting&&n.target===i)t(),r.disconnect()}));e.observe(i),this.waitForDelayLeaveFalse().then((()=>{e.disconnect(),r(new ae)}))}else r(new le(e))}))}async watchForPagePercentValueIntersectsWithViewport(e){return new Promise(((t,r)=>{const i=document.documentElement.scrollHeight*(e/be);function n(){if(document.documentElement.clientHeight+document.documentElement.scrollTop>i)t(),document.removeEventListener("scroll",n)}if(document.documentElement.clientHeight+document.documentElement.scrollTop>i)t();else document.addEventListener("scroll",n,true);this.waitForDelayLeaveFalse().then((()=>{document.removeEventListener("scroll",n),r(new ae)}))}))}},[oe.AwaitExit]:class extends ye{constructor(){super(...arguments),this.outs=zi.getNodeOutsInstance(oe.AwaitExit),this.type=oe.AwaitExit}handler(){return new Promise((e=>{const t=()=>{e(ce),this.cleanLeaveFalseTimeout()};document.documentElement.addEventListener("mouseleave",t,{once:true}),this.waitForDelayLeaveFalse().then((()=>{document.documentElement.removeEventListener("mouseout",t),e(ue)}))}))}},[oe.AwaitInactivity]:class extends ye{constructor(){super(...arguments),this.abortController=new AbortController,this.handlersMap={click:null,scroll:null,keydown:null,mousemove:null},this.type=oe.AwaitInactivity,this.outs=zi.getNodeOutsInstance(oe.AwaitInactivity)}handler(){const{inactivityTime:e}=this.properties;return new Promise((t=>{this.waitForDelayLeaveFalse().then((()=>{t(ue)})),this.waitForUserActivity(e).then((()=>{t(ce),this.cleanLeaveFalseTimeout()}))}))}async waitForUserActivity(e){const t=window.setTimeout((()=>{this.abortController.abort()}),e);try{return await Promise.race([this.waitForUserAction("scroll"),this.waitForUserAction("click"),this.waitForUserAction("keydown"),this.waitForUserAction("mousemove")]),window.clearTimeout(t),this.detachActivityMonitorHandlers(),this.waitForUserActivity(e)}catch(r){if(r instanceof rt)return;window.clearTimeout(t),Se.error(r)}}detachActivityMonitorHandlers(){const{click:e,keydown:t,scroll:r,mousemove:i}=this.handlersMap;document.removeEventListener("click",e),document.removeEventListener("scroll",r),document.removeEventListener("keydown",t),document.removeEventListener("mousemove",i),this.handlersMap={click:null,keydown:null,scroll:null,mousemove:null}}waitForUserAction(e){return new Promise(((t,r)=>{document.addEventListener(e,t,{once:true,capture:"scroll"===e}),this.handlersMap[e]=t,this.abortController.signal.addEventListener("abort",(()=>{r(new rt)}),{once:true})}))}},[oe.FilterSubscriber]:class extends fe{constructor(){super(...arguments),this.type=oe.FilterSubscriber,this.outs=zi.getNodeOutsInstance(oe.FilterSubscriber)}async handler(){let e="1"===pe("gaIsValuable");if(ke.canUseBackendForSubscriberIdentification())try{e=(await Ye.getVisitorData()).isConfirmedIdentifiedVisitor}catch(t){Se.error("Failed to load subscriber data",t)}return Promise.resolve(e?ce:ue)}},[oe.FilterDevice]:class extends fe{constructor(){super(...arguments),this.type=oe.FilterDevice,this.outs=zi.getNodeOutsInstance(oe.FilterDevice)}handler(){const{deviceType:e}=this.properties,t=Ve(Wt,jt).getDeviceType();if(e.includes(t))return Promise.resolve(ce);else return Promise.resolve(ue)}},[oe.FilterLocation]:class extends fe{constructor(){super(...arguments),this.type=oe.FilterLocation,this.outs=zi.getNodeOutsInstance(oe.FilterLocation)}handler(){return new Promise((async e=>{let{locations:t}=this.properties;if(null==t?void 0:t.length){if(t=(Array.isArray(t)?t:[t]).map((e=>e.toLowerCase())),t.includes(ot.All))return e(ce),void 0;try{const r=(await Ve(Ht,Kt).getVisitorCountryCode()).toLowerCase();if(t.includes(r))e(ce);else e(ue)}catch(r){if(r.status===Yt)e(ue);Se.error(r)}}else e(ce)}))}},[oe.FilterUrl]:class extends fe{constructor(){super(...arguments),this.type=oe.FilterUrl,this.outs=zi.getNodeOutsInstance(oe.FilterUrl)}handler(){const{urls:e}=this.properties;if(function(e,t){return(e=>e.map((e=>xi.create(e).withSlash().withLackOfProtocolAndWww().withLackOfProtocol().withLackOfWww().enhance())).flat(1))(t).some((t=>{const r=Array.from(t.matchAll(/[*+]/g));let i;if(r.length)i=r.reduce(((e,r,i,n)=>{var s;const o=[...e,Oi(t.substring(((null==(s=n[i-1])?void 0:s.index)??-1)+1,r.index)),"*"===r[0]?".*":"."];if(i===n.length-1)o.push(Oi(t.substring(r.index+1)));return o}),[]).join("");else i=Oi(t);return new RegExp(`^${i}$`).test((e=>{if(!e.includes("?")&&!e.endsWith("/"))return`${e}/`;else return e})(e))}))}(document.location.href,e))return Promise.resolve(ce);else return Promise.resolve(ue)}},[oe.FilterTime]:class extends fe{constructor(){super(...arguments),this.type=oe.FilterTime,this.outs=zi.getNodeOutsInstance(oe.FilterVisit)}handler(){const{beforeTime:e,afterTime:t}=this.properties,r=Date.now();let i=true,n=true;if(null===e&&null===t)return Promise.resolve(ce);if(this.validateProperties(),e)i=e>r;if(t)n=r>t;if(i&&n)return Promise.resolve(ce);else return Promise.resolve(ue)}validateProperties(){const{afterTime:e,beforeTime:t}=this.properties,r="number"==typeof e,i="number"==typeof t;if(e&&!r||t&&!i||(r&&i?e>=t:false))throw new Xt}},[oe.FilterECommerceActivity]:class extends fe{constructor(){super(...arguments),__privateAdd(this,T),__privateAdd(this,C),__privateAdd(this,D,void 0),__privateAdd(this,E,void 0),this.type=oe.FilterECommerceActivity,this.outs=zi.getNodeOutsInstance(oe.FilterECommerceActivity),__privateSet(this,D,(e=>{if(Bi(e,Ue.LikeItem)||Bi(e,Ue.UnlikeItem)){const{product:t,date:r}=this.properties.likeItem,{product:{id:i}}=e.data;if(t===pt.AnyProductLiked)return true;else if(!t.includes(i))return false;return __privateMethod(this,T,A).call(this,e,r,{ignoreToDateInDateRange:true})}})),__privateSet(this,E,(e=>{const{conditions:t}=this.properties,r=t[ht.Product],i=t[ht.Category],{date:n}=t;if(Bi(e,Ue.ViewItem)){const{data:{product:{id:t}}}=e;if(r===pt.AnyProduct)return true;else if(!(null==r?void 0:r.includes(t)))return false;return __privateMethod(this,T,A).call(this,e,n)}if(Bi(e,Ue.ViewCategory)){const{data:{id:t}}=e;if(i===pt.AnyCategory)return true;else if(!(null==i?void 0:i.includes(t)))return false;return __privateMethod(this,T,A).call(this,e,n)}return false}))}async handler(){var e;const t=0===Object.keys(this.properties).length;let r=t,i=t;if(this.properties.conditions){const{amount:e}=this.properties.conditions,t=await pi.getPopupECommerceEvents(__privateGet(this,E));r=__privateMethod(this,C,V).call(this,t,e)}if((null==(e=this.properties.likeItem)?void 0:e.product.length)>0){const e=(await pi.getPopupECommerceEvents(__privateGet(this,D))).reduce(((e,t)=>(e[t.data.product.id].push(t),e)),he([]));let t=Object.values(e).filter(Ri);if(this.properties.likeItem.date)t=t.map((e=>e.filter((e=>__privateMethod(this,T,A).call(this,e,this.properties.likeItem.date)))));i=t.some((e=>e.some((e=>e.eventType===Ue.LikeItem))))}return r||i?ce:ue}},[oe.FilterUniqueSessionVisit]:class extends fe{constructor(){super(...arguments),this.outs=zi.getNodeOutsInstance(oe.FilterUniqueSessionVisit),this.type=oe.FilterUniqueSessionVisit}handler(){return Promise.resolve(Gi.hasElementBeenVisited(this.id)?ue:ce)}},[oe.FilterVisit]:class extends fe{constructor(){super(...arguments),this.type=oe.FilterVisit,this.outs=zi.getNodeOutsInstance(oe.FilterVisit)}async handler(){const{frequency:e,frequencyDaysNumber:t,urlPath:r,visitors:i}=this.properties,n=Ve(Nr,Br);if(!n.validateUrlPath(r))return ue;const[s,o]=await Promise.all([n.validateFrequencyProperty(e,t),n.validateVisitorsProperty(i)]);if(s&&o)return ce;else return ue}},[oe.FilterPopup]:class extends fe{constructor(){super(...arguments),this.type=oe.FilterPopup,this.outs=zi.getNodeOutsInstance(oe.FilterPopup)}async handler(){const{popupId:e,showIfNotCloseBefore:t,showIfNotSubmittedBefore:r,showIfSeenLessThanAmount:i}=this.properties;if(!(await this.shouldPassFrequencyConditionCheck()))return ue;if(t&&await ki().hasPopupBeenClosedBefore(e))return ue;if(r&&await ki().hasPopupBeenSubmittedBefore(e))return ue;if(i&&await ki().getPopupImpressionsAmount(e)>=i)return ue;else return ce}async shouldPassFrequencyConditionCheck(){const{showEveryDays:e,frequency:t,popupId:r}=this.properties;if("session"===t)return!(await ki().hasPopupBeenSeenInSession(r));if("everyDays"===t&&e){const t=await ki().getLastPopupImpression(r);if(t)return Qe(t.getTime(),e);else return true}return true}},[oe.ReactScroll]:class extends fe{constructor(){super(...arguments),this.type=oe.ReactScroll,this.outs=zi.getNodeOutsInstance(oe.ReactScroll)}handler(){if(this.shouldProcessHandler()){const{selector:e}=this.properties,t=document.querySelector(e);if(t)return t.scrollIntoView({behavior:"smooth"}),Promise.resolve(ce)}}},[oe.ReactRedirect]:class extends fe{constructor(){super(...arguments),this.type=oe.ReactRedirect,this.outs=zi.getNodeOutsInstance(oe.ReactRedirect)}handler(){if(this.shouldProcessHandler()){const{url:e}=this.properties;return window.location.assign(e),Promise.resolve(void 0)}}},[oe.ReactDelay]:class extends fe{constructor(){super(...arguments),this.type=oe.ReactDelay,this.outs=zi.getNodeOutsInstance(oe.ReactDelay)}async handler(){const{delay:e}=this.properties;return await(t=e,new Promise((e=>{setTimeout(e,t)}))),ce;var t}},[oe.ReactPopup]:class extends fe{constructor(){super(...arguments),this.type=oe.ReactPopup,this.outs=zi.getNodeOutsInstance(oe.ReactPopup)}async handler(){var e;const{env:t,id:r,mode:i}=this.properties;if(await this.attachPopupLibrary(),i===Be.Inline)return null==(e=window.PopupsRenderer)?void 0:e.registerCustomElements(),ce;if(window.PopupsRenderer)if(this.shouldProcessHandler()){this.attachPopupEvents();try{await window.PopupsRenderer.renderPopupFromId(r,{env:window.PopupsRenderer.GeoEnvironment[t]})}catch(n){Se.error(n)}return ce}}attachPopupLibrary(){return new Promise(((e,t)=>{const r=document.createElement("script");r.src=ke.getPopupRendererCustomUrl()??Ui,r.async=true,r.addEventListener("load",e),r.addEventListener("error",t),document.head.appendChild(r)}))}attachPopupEvents(){window.PopupsRenderer.registerEventSubscriber((e=>{if(e instanceof window.PopupsRenderer.PopupEvents.Close)this.closePopupHandler();if(e instanceof window.PopupsRenderer.PopupEvents.BodyView)this.showPopupHandler();if(e instanceof window.PopupsRenderer.PopupEvents.FormLead)this.submitPopupHandler()}))}closePopupHandler(){ki().registerPopupClose(this.properties.id)}showPopupHandler(){ki().registerPopupView(this.properties.id)}submitPopupHandler(){ki().registerPopupSubmit(this.properties.id)}},[oe.ReactSendToBackend]:class extends fe{constructor(){super(...arguments),this.type=oe.ReactSendToBackend,this.outs=zi.getNodeOutsInstance(oe.ReactSendToBackend)}async handler(){if(this.shouldProcessHandler())return Promise.resolve(de)}}},qi={[oe.AwaitClick]:Mi,[oe.AwaitScroll]:Mi,[oe.AwaitExit]:Mi,[oe.AwaitInactivity]:Mi,[oe.FilterUrl]:Mi,[oe.FilterSubscriber]:Mi,[oe.FilterDevice]:Mi,[oe.FilterLocation]:Mi,[oe.FilterECommerceActivity]:Mi,[oe.FilterUniqueSessionVisit]:Mi,[oe.FilterTime]:Mi,[oe.FilterVisit]:Mi,[oe.FilterPopup]:Mi,[oe.ReactDelay]:ji,[oe.ReactScroll]:ji,[oe.ReactRedirect]:Ji,[oe.ReactPopup]:ji,[oe.ReactSendToBackend]:$i};class zi{static getNodeInstance(e,t){return new Hi[e](t)}static getNodeOutsInstance(e){return qi[e]}}function Ki(e){return"object"==typeof e&&null!==e&&"id"in e&&"status"in e&&"starting"in e}function Yi(e){var t;switch(e){case Me.TransferToBackend:return"backend_transfer";default:return null==(t=/(?<type>filter|react|await)_.*/g.exec(e))?void 0:t.groups.type}}function Xi(e){switch(e.type){case"transfer_to_backend":return{node_id:e.data.destination_node_id};default:return{upstream:e.upstream||null}}}const Zi=class{constructor(e){__privateAdd(this,k,void 0),__privateSet(this,k,e)}static create(e){return new Zi(e)}validate(e){return Object.entries(__privateGet(this,k)).reduce(((t,[r,i])=>{if(false===t)return t;if(void 0===e[r]&&i._isOptional)return t;else return i.call(e,e[r])}),true)}static string(){return en((e=>"string"==typeof e))}static number(){return en((e=>"number"==typeof e))}static boolean(){return en((e=>"boolean"==typeof e))}static dateString(){return en((e=>{if("string"!=typeof e)return false;else return!Number.isNaN(new Date(e).getTime())}))}static object(e){return en((t=>{if(!e||"object"!=typeof e)return false;else return Zi.create(e).validate(t)}))}static array(e){return en((t=>{if(!Array.isArray(t))return false;if("function"==typeof e)return t.every((t=>e(t)));const r=Zi.create(e);return t.every((e=>r.validate(e)))}))}};let Qi=Zi;function en(e){return e.optional=()=>(e._isOptional=true,e),e}k=new WeakMap;const tn=class{constructor(e){this.node={},Object.assign(this,e)}static create(e){var t;if(!__privateMethod(t=tn,U,L).call(t,e))throw new Error("Automation journey data does not match required schema");return new tn(e)}static createBlank(e){var t;if(!__privateMethod(t=tn,F,N).call(t,e))throw new Error("Automation journey data does not match required schema");return new tn(e)}updateJourneyData({node_entered_at:e,node:t,upstreamed_to:r}){this.node.uuid=t.uuid,this.upstreamed_to=r,this.node_entered_at=e}toJSON(){return structuredClone({...this})}};let rn=tn;function nn(e,t){return[e,t]}U=new WeakSet,L=e=>Qi.create({journey:Qi.object({uuid:Qi.string()}),visitor:Qi.object({uuid:Qi.string()}),node:Qi.object({uuid:Qi.string()}),node_entered_at:Qi.dateString(),upstreamed_to:Qi.dateString().optional()}).validate(e),F=new WeakSet,N=e=>Qi.create({journey:Qi.object({uuid:Qi.string()}),visitor:Qi.object({uuid:Qi.string()})}).validate(e),__privateAdd(rn,U),__privateAdd(rn,F),O=new WeakSet,x=(e,t,r)=>{if(0===e&&1===t)!(e=>{if(!e.objectStoreNames.contains(jr.VisitorJourneys))try{const t=e.createObjectStore(jr.VisitorJourneys,{keyPath:["journey.uuid","visitor.uuid"],autoIncrement:false}),r=e.createObjectStore(jr.VisitorJourneysGraphHistory,{keyPath:["node.uuid","visitor.uuid"],autoIncrement:false});t.createIndex($r.VisitorUuid,"visitor.uuid",{unique:false}),t.createIndex($r.JourneyIdentifier,"journey.uuid",{unique:false}),t.createIndex($r.VisitorUuidWithJourneyIdentifier,["visitor.uuid","journey.uuid"],{unique:false}),r.createIndex(Jr.VisitorUuid,"visitor.uuid",{unique:false}),r.createIndex(Jr.NodeUuid,"node.uuid",{unique:false}),r.createIndex(Jr.VisitorUuidWithNodeUuid,["visitor.uuid","node.uuid"],{unique:true})}catch(t){Se.error("Error while initializing/upgrading visitor journeys database",t)}})(r)};const sn=new class{constructor(){__privateAdd(this,O)}async getVisitorJourneys(e){const t=(await ci.openAutomationJourneysDatabaseConnection(__privateMethod(this,O,x))).transaction(jr.VisitorJourneys,"readonly"),r=t.objectStore(jr.VisitorJourneys).index($r.VisitorUuid),i=await r.getAll(e);return await t.done,i}async saveVisitorJourney(e){const{journey:t,visitor:r}=e,i=(await ci.openAutomationJourneysDatabaseConnection(__privateMethod(this,O,x))).transaction(jr.VisitorJourneys,"readwrite"),n=i.objectStore(jr.VisitorJourneys);await n.delete([t.uuid,r.uuid]),await n.add(e.toJSON()),await i.done}async clearVisitorJourney(e){const{journey:t,visitor:r}=e,i=(await ci.openAutomationJourneysDatabaseConnection(__privateMethod(this,O,x))).transaction(jr.VisitorJourneys,"readwrite"),n=i.objectStore(jr.VisitorJourneys);await n.delete([t.uuid,r.uuid]),await i.done}async getNodeEntryHistory(e,t){const r=(await ci.openAutomationJourneysDatabaseConnection(__privateMethod(this,O,x))).transaction(jr.VisitorJourneysGraphHistory,"readonly"),i=r.objectStore(jr.VisitorJourneysGraphHistory),n=await i.getAll(nn(e,t));return await r.done,n}async saveNodeHistoryEntry(e,t,r){const i=(await ci.openAutomationJourneysDatabaseConnection(__privateMethod(this,O,x))).transaction(jr.VisitorJourneysGraphHistory,"readwrite"),n=i.objectStore(jr.VisitorJourneysGraphHistory);await n.delete(nn(e,t)),await n.add({node:{uuid:e},visitor:{uuid:t},entered_at:r}),await i.done}},on=class{constructor({journey:e,visitor:t,grid:r,transitions:i}){__privateAdd(this,B,void 0),__privateSet(this,B,(new Date).toISOString()),this.grid=r,this.journey=e,this.visitor=t,this.transitions=i}static create(e){return new on(e)}toJSON(){return{...this}}};let an=on;B=new WeakMap;const cn="/visitors/{visitorUuid}/state",un=new class{getVisitorJourneys(e){return ze(new URL(cn,ke.visitorApplicationEndpoint).href.replace("{visitorUuid}",e))}sendVisitorTransitions(e){const{uuid:t}=e.journey;return ze(new URL(`/visitors/${t}/state`,ke.visitorApplicationEndpoint).href,{omitAidHeader:true,headers:{"Content-Type":"application/json"},body:JSON.stringify(e),method:"POST"})}},dn=class{constructor(e,t){__privateAdd(this,j),__privateAdd(this,H),__privateAdd(this,R,void 0),__privateAdd(this,W,void 0),__privateAdd(this,G,[]),__privateAdd(this,M,(e=>{const t=__privateMethod(this,j,$).call(this,e);return un.sendVisitorTransitions(t.toJSON())})),__privateAdd(this,J,(e=>{const t={},{fromPathKey:r,from:i,to:n,transitionTime:s}=e,o=__privateGet(this,R).originalGraph.nodes.find((e=>e.id===i.externalId)),a=n?__privateGet(this,R).originalGraph.nodes.find((e=>e.id===n.externalId)):null,c=__privateGet(this,R).originalGraph.transitions.find((e=>e.from===o.id&&e.to===(null==a?void 0:a.id))),u=__privateGet(this,R).originalGraph.transitions.some((e=>e.from===i.externalId&&e.fromStarting)),d=__privateGet(this,R).originalGraph.transitions.reduce(((e,t)=>{if(t.from===o.id)return t.fromElement;if(t.to===o.id)return t.toElement;else return e}),null),l=__privateGet(this,R).originalGraph.transitions.reduce(((e,t)=>{if(t.from===(null==a?void 0:a.id))return t.fromElement;if(t.to===(null==a?void 0:a.id))return t.toElement;else return e}),null);let p;if(__privateGet(this,R).outsMap[i.externalId])p=__privateGet(this,R).outsMap[i.externalId][r];if(!d||a&&!l)return null;if(t.leave={node:{id:o.id},path:(null==c?void 0:c.key)??p??r,occurred_at:s,element:{...u&&{starting:true},encodedId:d}},a)t.entered={node:{id:a.id,type:Yi(a.type),data:Xi(a)},occurred_at:s,element:{encodedId:l}};return t})),__privateSet(this,R,e),__privateSet(this,W,t)}static create(e,t){return new dn(e,t)}async addTransition(e){if(__privateGet(this,G).push(e),__privateMethod(this,H,q).call(this,e)){const e=[...__privateGet(this,G)];__privateSet(this,G,[]),await et((()=>__privateGet(this,M).call(this,e)),{multiplyDelay:true,maxAttempts:10})}}};let ln=dn;R=new WeakMap,W=new WeakMap,G=new WeakMap,M=new WeakMap,j=new WeakSet,$=function(e){const t=e.filter((e=>{var t;return e.from.externalId!==(null==(t=e.to)?void 0:t.externalId)})).map(__privateGet(this,J)).filter(Boolean);return an.create({journey:__privateGet(this,W).journey,visitor:{uuid:__privateGet(this,W).visitor.uuid},grid:ke.getClientLatestGrid(),transitions:t})},J=new WeakMap,H=new WeakSet,q=e=>{if(!e.to&&e.from.nodeTypeGroup!==se.BackendTransfer)return true;if(e.to.nodeTypeGroup===se.Await||e.to.nodeTypeGroup===se.BackendTransfer)return true;else return false};class pn{constructor({webflowSerializedData:e,visitorJourney:t,isJourneyGraph:r}){__privateAdd(this,z,void 0),__privateAdd(this,K,void 0),__privateAdd(this,Y,void 0),__privateAdd(this,X,pe(Ke.visitorUuid)),__privateAdd(this,Z,null),__privateSet(this,z,this.createWebFlowFromSerializedData(e)),__privateSet(this,K,t),__privateSet(this,Y,r)}initVisitorFlow(){const e=window.crypto.randomUUID();this.findStartingElements().forEach((t=>{let r;if(Ki(__privateGet(this,z))){if(__privateGet(this,K))r=rn.create(__privateGet(this,K));else r=rn.createBlank({journey:{uuid:e},visitor:{uuid:__privateGet(this,X)}});__privateSet(this,Z,ln.create(__privateGet(this,z),r))}this.shouldProcessFlow(t).then((e=>{if(e)this.processFlow(t,r)}))}))}async processFlow(e,t){try{const r=(new Date).toISOString();if(t)t.updateJourneyData({node:{uuid:e.id},node_entered_at:r});if(this.processNode(e).then((async i=>{if(Gi.addEntry(e.id),__privateGet(this,Y))await sn.saveNodeHistoryEntry(e.id,__privateGet(this,X),r);if(i&&await this.shouldProcessFlow(i))this.processFlow(i,t);else if(!i&&__privateGet(this,Y)&&e.type!==oe.ReactSendToBackend)await sn.clearVisitorJourney(t)})).catch((e=>{Se.error(e)})),__privateGet(this,Y))await sn.saveVisitorJourney(t)}catch(r){Se.error(r)}}async processNode(e){const t=this.getNodeConnectedToNodes(e);Se.log(`Processing node ${e.type} with id: ${e.id}`,e),e.startUpstreamCalculation();const r=await Promise.race([e.waitForUpstreamPassed(),e.handler()]);let i;if(r===Symbol.for("upstreamPassed"))i=ue;else i=r,e.cancelUpstreamToResolveWait();const n=t[i];if(__privateGet(this,Y))if(e.type!==oe.ReactSendToBackend)await __privateGet(this,Z).addTransition({from:e,to:n,fromPathKey:i,transitionTime:(new Date).toISOString()});return Se.log(`Finished processing node ${e.type} with id: ${e.id} with result ${i}`),n}getNodeConnectedToNodes(e){return __privateGet(this,z).connections.filter((t=>t.from===e.id)).reduce(((e,t)=>(e[t.fromPathKey]=__privateGet(this,z).nodes.find((e=>e.id===t.to)),e)),{})}findStartingElements(){var e,t;if(Ki(__privateGet(this,z))){const{starting:r,nodes:i,startAt:n,stopAt:s}=__privateGet(this,z),o=null==(e=__privateGet(this,K))?void 0:e.node;if(!(({startAt:e,stopAt:t})=>{const r=Date.parse(e),i=Date.parse(t),n=Date.now();if(!Number.isNaN(r)&&r>n)return false;if(!Number.isNaN(i)&&n>i)return false;else return true})({startAt:n,stopAt:s}))return[];if(o){const e=i.filter((e=>e.id===o.uuid));if((null==(t=e[0])?void 0:t.type)===oe.ReactSendToBackend)return[];else return e}if(r.length)return i.filter((e=>r.includes(e.externalId)));else return[]}const{nodes:r,connections:i}=__privateGet(this,z);return r.filter((e=>!i.some((t=>t.to===e.id))))}createWebFlowFromSerializedData(e){return{...e,nodes:e.nodes.map((e=>zi.getNodeInstance(e.type,{...e})))}}async shouldProcessFlow(e){var t,r,i;if(__privateGet(this,Y)){if(e.isRecurrent)return true;if((null==(r=null==(t=__privateGet(this,K))?void 0:t.node)?void 0:r.uuid)===e.id&&!Gi.hasElementBeenVisited(e.id))return true;if(null==(i=await sn.getNodeEntryHistory(e.id,__privateGet(this,X)))?void 0:i.length)return Se.log(`Element ${e.id} already visited`),false}return true}}z=new WeakMap,K=new WeakMap,Y=new WeakMap,X=new WeakMap,Z=new WeakMap;class hn{constructor(e,t){this.webEventFlowData=e,e.forEach((e=>{const r=Ki(e),i=r?t.get(e.id):null,n=new pn({webflowSerializedData:e,visitorJourney:i,isJourneyGraph:r});Se.log("New web event workflow initialized with data",e),Se.log("With journey data:",i),n.initVisitorFlow()}))}}var vn=(e=>(e["v2"]="v2",e["af"]="af",e["wp"]="wp",e["we"]="we",e["ec"]="ec",e))(vn||{}),gn=(e=>(e["v2"]="GRV2",e["af"]="GRAF",e["wp"]="GRWP",e["we"]="GRWE",e["ec"]="GREC",e))(gn||{});const wn=new class{isScriptDelayed(e){return Object.keys(ke.delayedScripts).includes(e)}delay(e){if(!this.isScriptDelayed(e))ke.delayedScripts={...ke.delayedScripts,[e]:void 0}}storeDelayedScriptParams(e,t){if(this.isScriptDelayed(e))ke.delayedScripts={...ke.delayedScripts,[e]:t}}initScript(e){var t;const r=ke.delayedScripts[e];if(r){ke.delayedScripts=Object.fromEntries(Object.entries(ke.delayedScripts).filter((([t])=>t!==e)));const i=gn[e];null==(t=null==window?void 0:window[i])?void 0:t.init(...r)}}},fn=new class{setCookie({expiresIn:e,domain:t="",value:r,name:i}){const n=this.getExpirationTimeString(e);document.cookie=`${i}=${r}; expires=${n}; path=/; ${t?`domain=${t}`:""}`}getExpirationTimeString(e){if(e instanceof Date)return e.toUTCString();const t=new Date;return t.setTime(t.getTime()+e),t.toUTCString()}getCookie(e){const t=document.cookie.match(new RegExp(`(^| )${e}=([^;]+)`));if(t)return t[2]}removeUuidCookieSessionInfo(){window.sessionStorage.removeItem(Ie.UuidHasBeenSet)}};Q=new WeakSet,ee=(e,t)=>t.find((t=>e.nodes.some((e=>e.id===t.node.uuid)))),te=new WeakSet,re=(e,t)=>e.reduce(((e,r)=>(e.set(r,t.find((e=>r.nodes.some((t=>t.id===e.node.uuid))))||null),e)),new Map),ie=new WeakSet,ne=e=>new Map(Array.from(e.entries()).map((([e,t])=>[e.id,t])));const yn=new class{constructor(){__privateAdd(this,Q),__privateAdd(this,te),__privateAdd(this,ie)}async getVisitorJourneys(e){const t=fn.getCookie(Ke.visitorUuid),r=await sn.getVisitorJourneys(t),i=__privateMethod(this,te,re).call(this,e,r),n=Array.from(i.values()).every(Boolean),s=r.some((t=>{if(t.node.uuid)return e.find((e=>{var r;return(null==(r=e.nodes.find((e=>e.id===t.node.uuid)))?void 0:r.type)===oe.ReactSendToBackend}));else return false}));if(n&&!s)return __privateMethod(this,ie,ne).call(this,i);const o=await un.getVisitorJourneys(t);return i.forEach(((e,t)=>{const r=__privateMethod(this,Q,ee).call(this,t,o);if(r)i.set(t,r)})),__privateMethod(this,ie,ne).call(this,i)}};function mn(e){return e&&"object"==typeof e&&"connections"in e&&"nodes"in e&&Array.isArray(e["nodes"])&&e["nodes"].length>0}let _n=null;async function Sn(e){Ur().saveUserVisit();const t=e.filter(Ki);let r=new Map;try{if(t.length>0)r=(await Promise.all([yn.getVisitorJourneys(t),Ii.migrateData().catch((e=>Se.warn("Failed to migrate popup data",e)))]))[0];else await Ii.migrateData()}catch(i){Se.error("Failed to get journey data",i)}if(null==e?void 0:e.length)if("complete"===window.document.readyState)_n=new hn(e,r);else window.addEventListener("load",(()=>{_n=new hn(e,r)}),{once:true})}e.init=e=>{const{visitorApplicationEndpoint:t,flowData:r}=JSON.parse(e);if(wn.isScriptDelayed(vn.we))return wn.storeDelayedScriptParams(vn.we,[e]),null;if(!ke.isWebEventModuleInitialized()){if(ke.setWebEventModuleInitialized(),ke.enablePopupDevMode(),t)ke.visitorApplicationEndpoint=t;(i=r,Promise.all(i.map((e=>{if(mn(e))return e;else if("flowDataUrl"in e)return fetch(e.flowDataUrl).then((e=>e.json())).then((e=>{if(mn(e))return e;else return null})).catch((e=>(Se.error("Failed to fetch web flow data",e),null)));return null})))).then((e=>e.filter(Boolean))).then((e=>{Sn(e),window.history.pushState=new Proxy(window.history.pushState,{apply(t,r,i){return Sn(e),ke.eventBus.publish(fr.FlushEvents),t.apply(r,i)}}),window.history.replaceState=new Proxy(window.history.replaceState,{apply(t,r,i){if(3===i.length&&!!i[2])Sn(e),ke.eventBus.publish(fr.FlushEvents);return t.apply(r,i)}}),window.addEventListener("popstate",(()=>{Sn(e),ke.eventBus.publish(fr.FlushEvents)}))}))}var i},Object.defineProperties(e,{__esModule:{value:true},[Symbol.toStringTag]:{value:"Module"}})}((e="undefined"!=typeof globalThis?globalThis:e||self).GRWE={})}(this);
